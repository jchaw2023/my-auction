# MyAuction 核心功能测试总结文档

## 📋 目录

- [测试概述](#测试概述)
- [测试环境](#测试环境)
- [测试用例列表](#测试用例列表)
- [详细测试说明](#详细测试说明)
- [测试执行流程](#测试执行流程)
- [测试结果示例](#测试结果示例)
- [常见问题排查](#常见问题排查)

---

## 测试概述

本文档总结了 MyAuction 项目的所有核心功能测试，包括基础拍卖功能和 V2 升级版本的增强功能测试。

### 测试覆盖范围

- ✅ NFT 拍卖基础功能
- ✅ 多币种出价功能（ETH/ERC20）
- ✅ Chainlink 价格预言机集成
- ✅ 平台手续费功能（固定/动态）
- ✅ 紧急暂停功能
- ✅ 统计信息功能
- ✅ 批量查询功能
- ✅ 合约升级功能

### 测试网络

- **Sepolia 测试网**: 主要测试网络
- **Localhost**: 本地开发测试

---

## 测试环境

### 前置条件

1. ✅ 合约已部署到 Sepolia 测试网
2. ✅ MyNFT 合约已部署并铸造了 NFT
3. ✅ MyAuction 合约已部署（V1 或 V2）
4. ✅ Chainlink 价格预言机已配置
5. ✅ 测试账户有足够的 ETH 和测试代币

### 环境变量

确保 `.env` 文件或 `hardhat.config.js` 中配置了正确的私钥和 RPC URL。

---

## 测试用例列表

### V1 基础功能测试

| 测试脚本 | 功能 | 命令 |
|---------|------|------|
| `get-auction-count-sepolia.js` | 获取拍卖总数 | `npx hardhat run test/get-auction-count-sepolia.js --network sepolia` |
| `get-auction-sepolia.js` | 获取单个拍卖详情 | `npx hardhat run test/get-auction-sepolia.js --network sepolia` |
| `bid-sepolia.js` | 出价功能测试 | `npx hardhat run test/bid-sepolia.js --network sepolia` |

### V2 功能测试

| 测试脚本 | 功能 | 命令 |
|---------|------|------|
| `test-v2-stats-sepolia.js` | 统计信息查询 | `npm run test:v2:stats` |
| `test-v2-platform-fee-sepolia.js` | 固定手续费设置 | `npm run test:v2:platform-fee` |
| `test-v2-set-fee-tiers-sepolia.js` | 动态手续费设置 | `npm run test:v2:set-fee-tiers` |
| `test-v2-dynamic-fee-sepolia.js` | 动态手续费计算 | `npm run test:v2:dynamic-fee` |
| `test-v2-pause-sepolia.js` | 暂停/恢复功能 | `npm run test:v2:pause` |
| `test-v2-batch-sepolia.js` | 批量查询功能 | `npm run test:v2:batch` |
| `test-v2-force-end-sepolia.js` | 强制结束拍卖 | `npm run test:v2:force-end` |

---

## 详细测试说明

### 1. V1 基础功能测试

#### 1.1 获取拍卖总数 (`get-auction-count-sepolia.js`)

**功能**: 查询合约中创建的拍卖总数

**测试步骤**:
1. 连接已部署的 MyAuction 合约
2. 调用 `getAuctionCount()` 函数
3. 显示拍卖总数

**预期结果**:
```
==========================================
获取拍卖总数
==========================================
网络: sepolia
MyAuction 地址: 0x...
==========================================

拍卖总数: 1
==========================================
```

**验证点**:
- ✅ 能够成功连接合约
- ✅ 返回正确的拍卖数量
- ✅ 数量 >= 0

---

#### 1.2 获取拍卖详情 (`get-auction-sepolia.js`)

**功能**: 查询指定拍卖的详细信息

**测试步骤**:
1. 连接已部署的 MyAuction 合约
2. 指定拍卖 ID
3. 调用 `getAuction(auctionId)` 函数
4. 显示拍卖详细信息

**需要修改的参数**:
```javascript
const AUCTION_ID = 0; // 修改为实际的拍卖 ID
```

**预期结果**:
```
==========================================
获取拍卖详情
==========================================
拍卖 ID: 0
==========================================

拍卖信息:
  NFT 地址: 0x...
  Token ID: 1
  卖家: 0x...
  最高出价者: 0x...
  最高出价代币: 0x0000000000000000000000000000000000000000 (ETH)
  最高出价: 0.1 ETH
  最高出价价值: $XXX USD
  起始价格: $XXX USD
  开始时间: XXX
  结束时间: XXX
  是否已结束: false
==========================================
```

**验证点**:
- ✅ 能够成功查询拍卖信息
- ✅ 所有字段都有正确的值
- ✅ NFT 地址和 Token ID 正确

---

#### 1.3 出价功能测试 (`bid-sepolia.js`)

**功能**: 测试使用 ETH 或 ERC20 代币进行出价

**需要修改的参数**:
```javascript
const AUCTION_ID = 0;        // 拍卖 ID
const BID_AMOUNT = "0.1";    // 出价金额
const TOKEN_TYPE = "ETH";    // "ETH" 或 "USDC"
```

**测试步骤**:
1. 连接已部署的 MyAuction 合约
2. 检查拍卖状态
3. 如果使用 ERC20，先授权代币
4. 发送出价交易
5. 等待交易确认
6. 验证出价结果

**预期结果**:
```
==========================================
出价测试
==========================================
拍卖 ID: 0
出价金额: 0.1 ETH
代币类型: ETH
==========================================

1️⃣  检查拍卖状态...
   ✅ 拍卖存在
   ✅ 拍卖未结束
   ✅ 拍卖已开始
   ✅ 价格预言机已配置

2️⃣  检查账户余额...
   ✅ 账户余额充足

3️⃣  发送出价交易...
   ✅ 交易哈希: 0x...
   ⏳ 等待交易确认...
   ✅ 交易已确认 (区块: XXX)

4️⃣  验证出价结果...
   ✅ 出价成功
   新的最高出价: 0.1 ETH
   新的最高出价者: 0x...
==========================================
```

**验证点**:
- ✅ 拍卖状态检查通过
- ✅ 账户余额充足
- ✅ 交易成功确认
- ✅ 最高出价和出价者已更新
- ✅ 如果之前有出价，已自动退款

**注意事项**:
- ⚠️ 出价金额必须高于当前最高出价的 USD 价值
- ⚠️ ETH 出价需要发送 `msg.value`
- ⚠️ ERC20 出价需要先授权合约使用代币

---

### 2. V2 功能测试

#### 2.1 统计信息查询 (`test-v2-stats-sepolia.js`)

**功能**: 查询合约的统计信息

**测试内容**:
- 总创建的拍卖数
- 总出价次数
- 当前平台手续费
- 暂停状态
- 活跃拍卖数
- 动态手续费启用状态
- 基础费率

**预期结果**:
```
==========================================
MyAuctionV2 统计信息查询
==========================================

统计信息:
  总创建的拍卖数: 1
  总出价次数: 3
  当前平台手续费: 0 基点 (0%)
  暂停状态: false
  活跃拍卖数: 1
  动态手续费启用: true
  基础费率: 500 基点 (5%)
==========================================
```

**验证点**:
- ✅ 能够成功调用 `getAuctionStats()` 函数
- ✅ 所有统计数据正确
- ✅ 版本号显示为 V2

---

#### 2.2 固定手续费设置 (`test-v2-platform-fee-sepolia.js`)

**功能**: 测试设置和查询固定平台手续费

**测试步骤**:
1. 检查合约版本和权限
2. 查询当前手续费
3. 设置新的手续费（例如 200 基点 = 2%）
4. 验证设置结果
5. 恢复为 0

**预期结果**:
```
==========================================
测试 MyAuctionV2 平台手续费功能
==========================================

1️⃣  检查合约版本...
   ✅ 合约版本: V2

2️⃣  检查账户权限...
   ✅ 当前账户是合约所有者

3️⃣  查询当前手续费...
   当前手续费: 0 基点 (0%)

4️⃣  设置平台手续费...
   📝 设置手续费为 200 基点 (2%)...
   ✅ 交易已确认

5️⃣  验证设置结果...
   新手续费: 200 基点 (2%)
   ✅ 手续费设置成功

6️⃣  恢复手续费为 0...
   ✅ 手续费已恢复为 0
==========================================
```

**验证点**:
- ✅ 只有合约所有者可以设置手续费
- ✅ 手续费设置成功
- ✅ 手续费不能超过 10% (1000 基点)
- ✅ 事件正确触发

---

#### 2.3 动态手续费设置 (`test-v2-set-fee-tiers-sepolia.js`)

**功能**: 设置和验证动态手续费档次

**测试内容**:
- 设置动态手续费档次
- 验证档次配置
- 测试不同金额的手续费计算
- 启用/禁用动态手续费

**费率档次配置**:
```
- $0 - $1,000: 5% (500 基点)
- $1,000 - $10,000: 3% (300 基点)
- $10,000 - $100,000: 1% (100 基点)
- $100,000+: 0.5% (50 基点)
```

**预期结果**:
```
==========================================
测试 MyAuctionV2 动态手续费设置功能
==========================================

5️⃣  设置新的动态手续费档次...
   ==========================================
   配置方案：金额越大，手续费率越低
   - $0 - $1,000: 5% (500 基点)
   - $1,000 - $10,000: 3% (300 基点)
   - $10,000 - $100,000: 1% (100 基点)
   - $100,000+: 0.5% (50 基点)
   ==========================================

   📝 发送设置手续费档次交易...
   ✅ 交易已确认

7️⃣  设置后的手续费档次:
   ==========================================
   档次 0: $0 - $1,000.00 → 5% (baseFeeRate)
   档次 1: $1,000.00 - $10,000.00 → 3%
   档次 2: $10,000.00 - $100,000.00 → 1%
   档次 3: $100,000.00+ → 0.5%
   ==========================================

8️⃣  测试不同金额的手续费计算:
   ==========================================
   $500: 手续费率: 5% ✅ (预期: 5%)
   $1,000: 手续费率: 3% ✅ (预期: 3%)
   $5,000: 手续费率: 3% ✅ (预期: 3%)
   $10,000: 手续费率: 1% ✅ (预期: 1%)
   $50,000: 手续费率: 1% ✅ (预期: 1%)
   $100,000: 手续费率: 0.5% ✅ (预期: 0.5%)
   $500,000: 手续费率: 0.5% ✅ (预期: 0.5%)
   ==========================================
```

**验证点**:
- ✅ 手续费档次设置成功
- ✅ 费率数组长度正确（比阈值数组多1）
- ✅ 费率递减逻辑正确
- ✅ 不同金额的手续费计算正确
- ✅ 动态手续费可以启用/禁用

---

#### 2.4 动态手续费计算 (`test-v2-dynamic-fee-sepolia.js`)

**功能**: 查看当前动态手续费配置并测试计算

**测试内容**:
- 查看当前手续费档次配置
- 测试不同金额的手续费计算
- 显示费率分配详情

**预期结果**:
```
==========================================
测试 MyAuctionV2 动态手续费计算
==========================================

4️⃣  手续费档次详情:
   ==========================================
   档次 0: $0 - $1,000.00 → 5% (baseFeeRate)
   档次 1: $1,000.00 - $10,000.00 → 3%
   档次 2: $10,000.00 - $100,000.00 → 1%
   档次 3: $100,000.00+ → 0.5%
   ==========================================

5️⃣  测试动态手续费计算...
   ==========================================
   $500 → 手续费率: 5% (500 基点)
   $1,000 → 手续费率: 3% (300 基点)
   $5,000 → 手续费率: 3% (300 基点)
   $10,000 → 手续费率: 1% (100 基点)
   $50,000 → 手续费率: 1% (100 基点)
   $100,000 → 手续费率: 0.5% (50 基点)
   $500,000 → 手续费率: 0.5% (50 基点)
   ==========================================
```

**验证点**:
- ✅ 能够正确读取手续费档次配置
- ✅ 手续费计算逻辑正确
- ✅ 费率递减趋势正确

---

#### 2.5 暂停/恢复功能 (`test-v2-pause-sepolia.js`)

**功能**: 测试紧急暂停和恢复功能

**测试步骤**:
1. 检查合约版本和权限
2. 查询当前暂停状态
3. 执行暂停操作
4. 验证暂停状态
5. 尝试执行操作（应该失败）
6. 执行恢复操作
7. 验证恢复状态

**预期结果**:
```
==========================================
测试 MyAuctionV2 暂停/恢复功能
==========================================

1️⃣  检查合约版本...
   ✅ 合约版本: V2

2️⃣  查询当前暂停状态...
   当前暂停状态: false (未暂停)

3️⃣  执行暂停操作...
   📝 发送暂停交易...
   ✅ 交易已确认
   ✅ 合约已暂停

4️⃣  验证暂停状态...
   暂停状态: true (已暂停)
   ✅ 暂停功能正常

5️⃣  测试暂停后的操作限制...
   ⚠️  创建拍卖失败（预期行为）
   ⚠️  出价失败（预期行为）

6️⃣  执行恢复操作...
   📝 发送恢复交易...
   ✅ 交易已确认
   ✅ 合约已恢复

7️⃣  验证恢复状态...
   暂停状态: false (未暂停)
   ✅ 恢复功能正常
==========================================
```

**验证点**:
- ✅ 只有合约所有者可以暂停/恢复
- ✅ 暂停后所有操作被阻止
- ✅ 恢复后操作恢复正常
- ✅ 事件正确触发

---

#### 2.6 批量查询功能 (`test-v2-batch-sepolia.js`)

**功能**: 测试批量获取拍卖信息

**测试内容**:
- 使用 `getAuctionsBatch()` 批量查询拍卖
- 测试不同的起始索引和数量
- 验证返回数据的正确性

**预期结果**:
```
==========================================
测试 MyAuctionV2 批量查询功能
==========================================

1️⃣  获取拍卖总数...
   总拍卖数: 5

2️⃣  测试批量查询...
   ==========================================
   查询参数: startIndex=0, count=3
   返回数量: 3
   ✅ 批量查询成功

   查询参数: startIndex=2, count=5
   返回数量: 3 (实际只有3个)
   ✅ 批量查询成功（自动处理边界）

3️⃣  验证数据正确性...
   ✅ 所有拍卖数据正确
==========================================
```

**验证点**:
- ✅ 批量查询功能正常
- ✅ 边界情况处理正确
- ✅ 返回数据格式正确

---

## 测试执行流程

### 完整测试流程

#### 阶段 1: 基础功能测试

```bash
# 1. 检查拍卖总数
npx hardhat run test/get-auction-count-sepolia.js --network sepolia

# 2. 查看拍卖详情（需要先修改脚本中的 auctionId）
npx hardhat run test/get-auction-sepolia.js --network sepolia

# 3. 测试出价功能（需要先修改脚本中的参数）
npx hardhat run test/bid-sepolia.js --network sepolia
```

#### 阶段 2: V2 功能测试

```bash
# 1. 查看统计信息
npm run test:v2:stats

# 2. 测试固定手续费
npm run test:v2:platform-fee

# 3. 设置动态手续费档次
npm run test:v2:set-fee-tiers

# 4. 测试动态手续费计算
npm run test:v2:dynamic-fee

# 5. 测试暂停功能
npm run test:v2:pause

# 6. 测试批量查询
npm run test:v2:batch
```

### 快速测试流程

如果只想快速验证核心功能：

```bash
# 1. 设置动态手续费档次（包含费率计算测试）
npm run test:v2:set-fee-tiers

# 2. 查看统计信息
npm run test:v2:stats

# 3. 测试出价功能
npx hardhat run test/bid-sepolia.js --network sepolia
```

---

## 测试结果示例

### 成功示例

```
==========================================
✅ 所有测试通过
==========================================

基础功能测试:
  ✅ 获取拍卖总数: 通过
  ✅ 获取拍卖详情: 通过
  ✅ 出价功能: 通过

V2 功能测试:
  ✅ 统计信息查询: 通过
  ✅ 固定手续费设置: 通过
  ✅ 动态手续费设置: 通过
  ✅ 动态手续费计算: 通过
  ✅ 暂停/恢复功能: 通过
  ✅ 批量查询功能: 通过
```

### 失败示例

如果测试失败，通常会显示：

```
❌ 测试失败:
错误信息: ...
```

常见错误：
- 合约未部署
- 账户权限不足
- 网络连接问题
- Gas 不足
- 参数错误

---

## 常见问题排查

### Q1: 测试脚本报错 "无法加载部署信息"

**原因**: 合约未部署或部署信息不存在

**解决方案**:
1. 确认合约已部署到目标网络
2. 检查 `deployments/<network>/` 目录下是否有部署文件
3. 重新部署合约

### Q2: 出价测试失败 "Bid value must be greater than..."

**原因**: 出价金额低于当前最高出价的 USD 价值

**解决方案**:
1. 查询当前最高出价
2. 提高出价金额
3. 确保出价金额的 USD 价值高于当前最高出价

### Q3: 手续费设置失败 "Only owner can call this function"

**原因**: 当前账户不是合约所有者

**解决方案**:
1. 确认使用部署账户
2. 检查 `hardhat.config.js` 中的账户配置
3. 使用正确的私钥

### Q4: 动态手续费计算返回 0%

**原因**: 动态手续费未启用或未设置档次

**解决方案**:
1. 先运行 `test-v2-set-fee-tiers-sepolia.js` 设置手续费档次
2. 确认 `useDynamicFee` 为 `true`
3. 确认 `feeTiers` 数组不为空

### Q5: 价格预言机相关错误

**原因**: 价格预言机未配置或配置错误

**解决方案**:
1. 确认已部署 MyAuction 合约（会自动配置 Sepolia 的价格预言机）
2. 检查价格预言机地址是否正确
3. 确认网络连接正常

### Q6: Gas 不足错误

**原因**: 账户余额不足

**解决方案**:
1. 检查账户余额
2. 从水龙头获取测试 ETH（Sepolia）
3. 减少测试交易数量

---

## 测试检查清单

### 部署前检查

- [ ] 合约已编译
- [ ] 网络配置正确
- [ ] 账户有足够的 ETH
- [ ] 环境变量配置正确

### 基础功能检查

- [ ] MyNFT 合约已部署
- [ ] NFT 已铸造
- [ ] MyAuction 合约已部署
- [ ] 价格预言机已配置
- [ ] 至少创建一个拍卖

### V2 功能检查

- [ ] 合约已升级到 V2
- [ ] V2 功能已初始化
- [ ] 合约所有者权限正确
- [ ] 动态手续费档次已设置（如需要）

### 测试执行检查

- [ ] 所有基础功能测试通过
- [ ] 所有 V2 功能测试通过
- [ ] 出价功能正常
- [ ] 手续费计算正确
- [ ] 暂停功能正常

---

## 测试报告模板

### 测试环境

- **网络**: Sepolia 测试网
- **合约地址**: 
  - MyNFT: `0x...`
  - MyAuction Proxy: `0x...`
  - MyAuction Implementation: `0x...`
- **测试账户**: `0x...`
- **测试时间**: YYYY-MM-DD HH:MM:SS

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 获取拍卖总数 | ✅/❌ | |
| 获取拍卖详情 | ✅/❌ | |
| 出价功能 | ✅/❌ | |
| 统计信息查询 | ✅/❌ | |
| 固定手续费设置 | ✅/❌ | |
| 动态手续费设置 | ✅/❌ | |
| 动态手续费计算 | ✅/❌ | |
| 暂停/恢复功能 | ✅/❌ | |
| 批量查询功能 | ✅/❌ | |

### 问题记录

1. **问题描述**: ...
   - **原因**: ...
   - **解决方案**: ...

---

## 相关文档

- [部署文档](./DEPLOYMENT.md) - 详细的部署说明
- [测试报告](./TEST_REPORT.md) - 详细测试结果
- [项目总结](./PROJECT_SUMMARY.md) - 项目总结报告
- [合约代码](../contracts/) - 智能合约源码
- [测试脚本](../test/) - 所有测试脚本

---

**最后更新**: 2024年

